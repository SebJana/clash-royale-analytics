server {
    listen 80;

    # For Docker environments: trust the docker gateway and host network
    real_ip_header X-Forwarded-For;
    set_real_ip_from 172.18.0.0/16;  # The specific Docker network
    set_real_ip_from 172.16.0.0/12;  # Docker's default bridge networks  
    set_real_ip_from 10.0.0.0/8;     # Docker's custom networks
    set_real_ip_from 192.168.0.0/16; # Local networks
    set_real_ip_from 127.0.0.1;      # Localhost
    real_ip_recursive on;

    location / {
        root /usr/share/nginx/html;
        index index.html index.htm;
        try_files $uri /index.html;
    }

    # Proxy all /api to backend container
    location /api/ {
        proxy_pass http://api:8000/api/;

        # Enhanced IP forwarding that handles Docker NAT
        # Pass the real remote addr that nginx sees
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # Pass what nginx detected as real IP (for cases with existing X-Forwarded-For)
        proxy_set_header X-Nginx-Real-IP $realip_remote_addr;

        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection keep-alive;
        proxy_set_header Host $host;
    }
}
